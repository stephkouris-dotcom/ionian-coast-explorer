<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>For Owners • Ionian Coast Explorer</title>

  <link rel="stylesheet" href="/brand/brand.css">
  <link rel="stylesheet" href="/style.css">

  <link rel="icon" href="/assets/logo/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/logo/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#154B74">

 
</head>
<body>
  <header class="site-header">
    <a href="/" class="brand" aria-label="Ionian Coast Explorer">
      <img src="/assets/logo/ionian-logo-horizontal.svg" alt="Ionian Coast Explorer" class="logo logo--header">
      <strong>Ionian Coast Explorer</strong>
    </a>
    <nav class="main-nav" aria-label="Primary">
      <a href="/explore.html">Explore</a>
      <a href="/owners.html" class="btn btn-primary">For Owners</a>
    </nav>
  </header>

  <main>
    <h2>Owner Dashboard</h2>
    <p class="muted">Sign in to add and manage your listings.</p>

    <!-- AUTH -->
    <section id="auth-panel" class="card" style="margin-top:1rem;">
      <div id="signed-out">
        <label for="email">Email (magic link)</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
        <button type="button" id="send-link" class="btn btn-ghost" style="margin-top:.5rem;">Send magic link</button>
        <p id="auth-msg" class="small" style="margin-top:.5rem;"></p>

        <hr style="margin:1rem 0;border:none;border-top:1px solid var(--border)">

        <p class="small muted">Or sign in with email + password</p>
        <label for="pw-email">Email</label>
        <input id="pw-email" type="email" placeholder="you@example.com" autocomplete="email" />
        <label for="pw-password">Password</label>
        <input id="pw-password" type="password" placeholder="Minimum 6 characters" autocomplete="current-password" />
        <div style="display:flex; gap:.5rem; margin-top:.5rem;">
          <button type="button" id="pw-signup" class="btn btn-ghost">Create account</button>
          <button type="button" id="pw-login" class="btn btn-ghost">Sign in</button>
        </div>
        <p id="pw-msg" class="small" style="margin-top:.5rem;"></p>
      </div>

      <div id="signed-in" style="display:none">
        <p class="small">Signed in as <strong id="user-email"></strong></p>
        <button type="button" id="sign-out" class="btn btn-ghost" style="margin-top:.5rem;">Sign out</button>
      </div>
    </section>

    <!-- CREATE LISTING -->
    <section id="create-panel" class="card" style="margin-top:1rem; display:none;">
      <h3>Create a new listing</h3>
      <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(240px,1fr));">
        <div>
          <label for="title">Title</label>
          <input id="title" type="text" placeholder="Villa Thalassa" />
        </div>

        <div>
          <label for="category">Category</label>
          <select id="category">
            <option value="">Select…</option>
            <option value="accommodation">Accommodation</option>
            <option value="boating">Boating</option>
            <option value="cuisine">Cuisine</option>
            <option value="coastal_life">Coastal Life</option>
          </select>
        </div>

        <div>
          <label for="region">Region</label>
          <select id="region">
            <option value="">Select…</option>
            <option value="thesprotia">Thesprotia</option>
            <option value="corfu_south">Corfu South</option>
            <option value="paxi">Paxi</option>
          </select>
        </div>

        <div>
          <label for="price_from">Price from (€)</label>
          <input id="price_from" type="number" min="0" step="1" placeholder="180" />
        </div>

        <div>
          <label for="location">Location</label>
          <input id="location" type="text" placeholder="Gaios, Paxos" />
        </div>

        <!-- IMAGE UPLOAD -->
        <div style="grid-column: 1 / -1;">
          <label for="image_url">Cover image URL</label>
          <input id="image_url" type="url" placeholder="https://…" />
          <p class="small muted">You can paste a URL or upload a file below.</p>

          <div class="card" style="padding:1rem; margin-top:.5rem;">
            <label class="small" for="file">Upload image</label>
            <input id="file" type="file" accept="image/*" />
            <div style="display:flex; gap:.5rem; align-items:center; margin-top:.5rem;">
              <button type="button" id="upload" class="btn btn-ghost">Upload</button>
              <span id="upload-msg" class="small"></span>
            </div>
            <img id="preview" alt="" style="display:none; width:100%; max-height:240px; object-fit:cover; border-radius:12px; margin-top:.5rem;">
          </div>
        </div>

        <div style="grid-column: 1 / -1;">
          <label for="description">Description</label>
          <textarea id="description" rows="4" placeholder="Short description…"></textarea>
        </div>
      </div>

      <div style="margin-top:.75rem; display:flex; gap:.75rem; align-items:center;">
        <label class="small" for="published">
          <input id="published" type="checkbox" /> Published
        </label>
        <button type="button" id="create" class="btn btn-primary">Create listing</button>
        <span id="create-msg" class="small"></span>
      </div>
    </section>

    <!-- MY LISTINGS -->
    <section id="my-listings" style="margin-top:1rem; display:none;">
      <h3>My listings</h3>
      <div id="list" class="grid" style="margin-top: .75rem;"></div>
      <p id="empty" class="muted" style="display:none;">No listings yet.</p>
    </section>
  </main>

  <script>
    // >>> Put your values here <<<
    const SUPABASE_URL = 'https://tromqpxzlqazzzfqejer.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyb21xcHh6bHFhenp6ZnFlamVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODc5MjIsImV4cCI6MjA3NDk2MzkyMn0.LSbRypXuCtR1bwOEy9C7vdg2etYNCFsyMBWk1cg8WQo';

    // Guard: show a clear alert if the library didn’t load
    window.addEventListener('load', () => {
      if (!window.supabase) {
        alert('Supabase library failed to load. Check your internet and try hard refresh (Ctrl/Cmd+Shift+R).');
      }
    });

    const supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const els = {
      signedOut: document.getElementById('signed-out'),
      signedIn: document.getElementById('signed-in'),
      userEmail: document.getElementById('user-email'),
      authMsg: document.getElementById('auth-msg'),
      createPanel: document.getElementById('create-panel'),
      myListings: document.getElementById('my-listings'),
      list: document.getElementById('list'),
      empty: document.getElementById('empty'),
      file: document.getElementById('file'),
      uploadBtn: document.getElementById('upload'),
      uploadMsg: document.getElementById('upload-msg'),
      preview: document.getElementById('preview'),
      pwMsg: document.getElementById('pw-msg'),
    };

    // MAGIC LINK (optional)
    document.getElementById('send-link').addEventListener('click', async () => {
      try {
        const email = document.getElementById('email').value.trim();
        if (!email) return (els.authMsg.textContent = 'Enter your email.');
        els.authMsg.textContent = 'Sending link…';
        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: window.location.origin + '/owners.html' }
        });
        els.authMsg.textContent = error ? ('Error: ' + error.message) : 'Check your email for the sign-in link.';
      } catch (e) { alert(e.message); }
    });

    // EMAIL + PASSWORD
    document.getElementById('pw-signup').addEventListener('click', async () => {
      try {
        const email = document.getElementById('pw-email').value.trim();
        const password = document.getElementById('pw-password').value;
        if (!email || !password) return els.pwMsg.textContent = 'Enter email and password.';
        if (password.length < 6) return els.pwMsg.textContent = 'Password must be at least 6 characters.';
        els.pwMsg.textContent = 'Creating account…';
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) { els.pwMsg.textContent = 'Error: ' + error.message; alert(error.message); return; }
        els.pwMsg.textContent = (data.session ? 'Account created & signed in ✔' : 'Account created. Now click “Sign in”.');
        init();
      } catch (e) { els.pwMsg.textContent = 'Error: ' + e.message; alert(e.message); }
    });

    document.getElementById('pw-login').addEventListener('click', async () => {
      try {
        const email = document.getElementById('pw-email').value.trim();
        const password = document.getElementById('pw-password').value;
        if (!email || !password) return els.pwMsg.textContent = 'Enter email and password.';
        els.pwMsg.textContent = 'Signing in…';
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) { els.pwMsg.textContent = 'Error: ' + error.message; alert(error.message); return; }
        els.pwMsg.textContent = 'Signed in ✔';
        init();
      } catch (e) { els.pwMsg.textContent = 'Error: ' + e.message; alert(e.message); }
    });

    document.getElementById('sign-out').addEventListener('click', async () => {
      await supabase.auth.signOut();
      location.reload();
    });

    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) {
        els.signedOut.style.display = 'none';
        els.signedIn.style.display = 'block';
        els.userEmail.textContent = session.user.email || session.user.id;
        els.createPanel.style.display = 'block';
        els.myListings.style.display = 'block';
        loadMyListings(session.user);
      } else {
        els.signedOut.style.display = 'block';
        els.signedIn.style.display = 'none';
        els.createPanel.style.display = 'none';
        els.myListings.style.display = 'none';
      }
    }

    // (Upload + create listing functions unchanged from earlier)
    els.file.addEventListener('change', () => {
      const f = els.file.files?.[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = e => { els.preview.src = e.target.result; els.preview.style.display = 'block'; };
      reader.readAsDataURL(f);
    });

    els.uploadBtn.addEventListener('click', async () => {
      const f = els.file.files?.[0];
      if (!f) return (els.uploadMsg.textContent = 'Choose a file first.');
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) return (els.uploadMsg.textContent = 'Please sign in first.');

      els.uploadMsg.textContent = 'Uploading…';
      const path = `${session.user.id}/${Date.now()}-${f.name.replace(/\s+/g,'-')}`;
      const { error } = await supabase.storage.from('listing-images').upload(path, f, { cacheControl: '3600', upsert: false });
      if (error) { els.uploadMsg.textContent = 'Error: ' + error.message; alert(error.message); return; }
      const { data: pub } = supabase.storage.from('listing-images').getPublicUrl(path);
      document.getElementById('image_url').value = pub.publicUrl;
      els.uploadMsg.textContent = 'Uploaded ✔';
    });

    document.getElementById('create').addEventListener('click', async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) return alert('Please sign in first.');

      const title = document.getElementById('title').value.trim();
      const category = document.getElementById('category').value;
      const region = document.getElementById('region').value;
      const price_from = document.getElementById('price_from').value ? Number(document.getElementById('price_from').value) : null;
      const locationText = document.getElementById('location').value.trim();
      const image_url = document.getElementById('image_url').value.trim();
      const description = document.getElementById('description').value.trim();
      const published = document.getElementById('published').checked;

      if (!title || !category || !region) {
        document.getElementById('create-msg').textContent = 'Title, category, and region are required.';
        return;
      }

      document.getElementById('create-msg').textContent = 'Saving…';
      let insertObj = { title, category, region, description, image_url, price_from, location: locationText, published, owner_id: session.user.id };
      let { error } = await supabase.from('listings').insert(insertObj);
      if (error && /owner_id/.test(error.message)) {
        delete insertObj.owner_id; insertObj.owner_user_id = session.user.id;
        ({ error } = await supabase.from('listings').insert(insertObj));
      }
      if (error) { document.getElementById('create-msg').textContent = 'Error: ' + error.message; alert(error.message); return; }

      document.getElementById('create-msg').textContent = 'Saved!';
      ['title','price_from','location','image_url','description'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('category').value = '';
      document.getElementById('region').value = '';
      document.getElementById('published').checked = false;
      els.preview.style.display = 'none';
      loadMyListings(session.user);
    });

    async function loadMyListings(user) {
      els.list.innerHTML = '';
      els.empty.style.display = 'none';
      let { data, error } = await supabase.from('listings')
        .select('*').eq('owner_id', user.id)
        .order('created_at', { ascending: false }).limit(50);
      if (error && error.message.includes('owner_id')) {
        const res = await supabase.from('listings')
          .select('*').eq('owner_user_id', user.id)
          .order('created_at', { ascending: false }).limit(50);
        data = res.data; error = res.error;
      }
      if (error) { els.list.innerHTML = `<div class="card">Error loading listings: ${error.message}</div>`; return; }
      if (!data || data.length === 0) { els.empty.style.display = 'block'; return; }

      for (const item of data) {
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          ${item.image_url ? `<img src="${item.image_url}" alt="" style="width:100%;height:160px;object-fit:cover;border-radius:12px;margin-bottom:.5rem">` : ''}
          <h3 style="margin-bottom:.25rem">${item.title}</h3>
          <p class="small muted" style="margin:0 0 .5rem 0;">
            ${item.category?.replace('_',' ') || ''} · ${item.region?.replace('_',' ') || ''} ${item.price_from ? `· €${Number(item.price_from).toFixed(0)}+` : ''}
          </p>
          <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
            <button type="button" class="btn btn-ghost" data-action="toggle" data-id="${item.id}" data-pub="${item.published ? '1' : '0'}">
              ${item.published ? 'Unpublish' : 'Publish'}
            </button>
            <button type="button" class="btn btn-ghost" data-action="delete" data-id="${item.id}">Delete</button>
          </div>
        `;
        els.list.appendChild(card);
      }

      els.list.querySelectorAll('button[data-action="toggle"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const current = btn.getAttribute('data-pub') === '1';
          const { error } = await supabase.from('listings').update({ published: !current }).eq('id', id);
          if (error) return alert('Error: ' + error.message);
          init();
        });
      });

      els.list.querySelectorAll('button[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          if (!confirm('Delete this listing?')) return;
          const { error } = await supabase.from('listings').delete().eq('id', id);
          if (error) return alert('Error: ' + error.message);
          init();
        });
      });
    }

    supabase?.auth.onAuthStateChange(() => { init(); });
    init();
  </script>
</body>
</html>
