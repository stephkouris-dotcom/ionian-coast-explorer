<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Explore • Ionian Coast Explorer</title>

  <!-- Brand & site styles -->
  <link rel="stylesheet" href="/brand/brand.css">
  <link rel="stylesheet" href="/style.css">

  <!-- Icons & PWA (optional but nice) -->
  <link rel="icon" href="/assets/logo/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/logo/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#154B74">

  <!-- Supabase JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <a href="/" class="brand" aria-label="Ionian Coast Explorer">
      <img src="/assets/logo/ionian-logo-horizontal.svg" alt="Ionian Coast Explorer" class="logo logo--header">
      <strong>Ionian Coast Explorer</strong>
    </a>
    <nav class="main-nav" aria-label="Primary">
      <a href="/explore.html">Explore</a>
      <a href="/owners.html">For Owners</a>
    </nav>
  </header>

  <main>
    <h2>Explore Listings</h2>
    <p class="muted">Browse authentic accommodation, boating, cuisine, and coastal life.</p>

    <!-- Simple filters -->
    <div class="cta" style="margin:1rem 0;">
      <button class="btn btn-ghost" data-filter="">All</button>
      <button class="btn btn-ghost" data-filter="accommodation">Accommodation</button>
      <button class="btn btn-ghost" data-filter="boating">Boating</button>
      <button class="btn btn-ghost" data-filter="cuisine">Cuisine</button>
      <button class="btn btn-ghost" data-filter="coastal_life">Coastal Life</button>
    </div>

    <!-- Cards go here -->
    <div id="listings" class="grid" style="margin-top:1.25rem"></div>
    <p id="empty" class="muted" style="display:none; margin-top:1rem;">No listings yet.</p>
  </main>

  <script>
    // 1) REPLACE these with your project values (same ones you used in owners.html)
    const SUPABASE_URL = 'https://tromqpxzlqazzzfqejer.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyb21xcHh6bHFhenp6ZnFlamVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODc5MjIsImV4cCI6MjA3NDk2MzkyMn0.LSbRypXuCtR1bwOEy9C7vdg2etYNCFsyMBWk1cg8WQo';

    // 2) Client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 3) Elements
    const listingsEl = document.getElementById('listings');
    const emptyEl = document.getElementById('empty');

    // 4) Load & render listings (published only)
    async function loadListings(category = '') {
      listingsEl.innerHTML = '';
      let query = supabase
        .from('listings')
        .select('*')
        .eq('published', true)
        .order('created_at', { ascending: false })
        .limit(40);

      if (category) query = query.eq('category', category);

      const { data, error } = await query;
      if (error) {
        listingsEl.innerHTML = '<div class="card">Error loading listings.</div>';
        console.error(error);
        return;
      }

      if (!data || data.length === 0) {
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';

      for (const item of data) {
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          ${item.image_url ? `<img src="${item.image_url}" alt="" style="width:100%;height:180px;object-fit:cover;border-radius:12px;margin-bottom:.75rem">` : ''}
          <h3>${item.title}</h3>
          <p class="small" style="margin:.25rem 0 .5rem 0">
            ${item.category.replace('_',' ')} · ${item.region.replace('_',' ')}${item.price_from ? ` · from €${Number(item.price_from).toFixed(0)}` : ''}
          </p>
          <p>${(item.description || '').slice(0,140)}${(item.description && item.description.length > 140) ? '…' : ''}</p>
        `;
        listingsEl.appendChild(card);
      }
    }

    // 5) Filter buttons & deep-link via hash
    document.querySelectorAll('[data-filter]').forEach(btn => {
      btn.addEventListener('click', () => {
        const val = btn.getAttribute('data-filter');
        loadListings(val);
        if (val) location.hash = val; else history.pushState("", document.title, window.location.pathname);
      });
    });

    // Initial load
    const initial = location.hash ? location.hash.slice(1) : '';
    loadListings(initial);
  </script>
</body>
</html>
